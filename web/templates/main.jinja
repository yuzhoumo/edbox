<!-- main section for displaying current post -->
<div
  id="grid-column-current-post"
  :class="cn([
    'col-span-6', 'lg:col-span-3', 'h-[100vh]', 'space-y-4',
    'overflow-y-auto', 'bg-gray-900', 'pb-4'
  ])"
  x-init="$watch('$store.data.currentPost', (p) => { currentPost = p })"
  x-data="{
    currentPost: $store.data.currentPost, userMap: getUsers()
  }"
>
  <!-- button for triggering latex typesetting -->
  <div
    id="container-btn-typeset-latex"
    class="px-4 pt-4" x-data="{ shown: containsInlineLatex(currentPost) }"
    x-effect="shown = containsInlineLatex(currentPost)"
    x-show="shown"
  >
    <button
      id="btn-typeset-latex"
      :class="cn([
        'w-full', 'rounded-md', 'bg-green-400', 'px-2', 'py-1',
        'text-sm', 'text-green-900', 'hover:bg-green-500'
      ])"
      x-on:click="shown = false; MathJax.typesetPromise()"
    >
      Click here to show LaTeX
    </button>
  </div>

  <!-- main post content -->
  <div
    id="main-post"
    :class="cn([
      'mx-4', 'mt-4', 'rounded-lg', 'border',
      'border-gray-700', 'bg-gray-800', 'text-white'
    ])"
  >
    <div class="space-y-8 p-8">
      <div
        id="main-post-header"
        class="flex gap-4 text-2xl font-light items-end"
      >
        <span
          id="main-post-title"
          x-text="currentPost.title"
        ></span>
        <span
          class="text-xl text-gray-400 font-thin"
          x-text="' #' + currentPost.number"
        ></span>
      </div>

      <div id="user-avatar" class="flex items-center gap-2">
        <template x-if="currentPost.is_anonymous">
          <img class="size-10 rounded-full bg-gray-600" :src="IMG_ANON_AVATAR" draggable="false" aria-hidden="true">
        </template>
        <template x-if="!currentPost.is_anonymous && getAvatar(currentPost, userMap)">
          <img class="size-10 rounded-full" :src="getAvatar(currentPost, userMap)" alt="user avatar">
        </template>
        <template x-if="!currentPost.is_anonymous && !getAvatar(currentPost, userMap)">
          <div class="relative inline-flex items-center justify-center w-10 h-10 overflow-hidden bg-gray-100 rounded-full dark:bg-gray-600">
            <span
              class="font-light text-gray-600 dark:text-gray-300"
              x-text="getNameAbbrev(currentPost, userMap)"
            ></span>
          </div>
        </template>

        <div class="flex flex-col">
          <div class="flex gap-1 font-light dark:text-white items-center">
            <span x-text="currentPost.is_anonymous ? 'Anonymous' : getAuthorName(currentPost, userMap)"></span>
            <span class="text-sm text-gray-500 dark:text-gray-400"></span>
            <span
              class="text-[0.5rem] font-semibold bg-[#372dad] rounded-md px-1 py-[2px]"
              x-show="!currentPost.is_anonymous && userMap[currentPost.user_id].course_role === 'admin'"
            >
              STAFF
            </span>
          </div>

          <span
            class="text-xs text-semibold"
            x-text="'Posted in ' + getFullCategory(currentPost)"
          ></span>
        </div>
      </div>

      <div id="main-post-body" class="overflow-x-auto">
        <span
          id="main-post-content"
          class="space-y-2 text-sm"
          x-html="currentPost.content"
        ></span>
      </div>
    </div>

    <div
      id="main-post-footer"
      :class="cn([
        'flex', 'w-full', 'justify-between', 'border-t',
        'border-gray-700', 'px-4', 'py-2', 'align-middle'
      ])"
    >
      <div id="current-post-footer-info" class="flex gap-3 text-xs">
        <div id="current-post-likes" class="flex gap-1 items-center">
          <span class="text-red-400">&hearts;</span>
          <span x-text="currentPost.vote_count + (currentPost.vote_count === 1 ? ' like' : ' likes')"></span>
        </div>
        <span x-text="currentPost.view_count + ' total views'"></span>
        <span x-text="currentPost.unique_view_count + ' unique views'"></span>
      </div>
      <span
        id="main-post-last-updated-by"
        class="text-xs"
        x-html="
          'Last updated ' + formatDate(currentPost.updated_at) +
          ' by <b>' + (currentPost.is_anonymous ? 'Anonymous' :
          userMap[currentPost.user_id].name) + '</b>'
        "
      ></span>
    </div>
  </div>

  <div
    :class="cn([
      'mx-4', 'my-4', 'py-4', 'rounded-lg', 'border',
      'border-gray-700', 'bg-gray-800', 'text-white'
    ])"
    x-show="currentPost.comments.length > 0"
  >
    <!-- post comments -->
    <template
      x-for="item in flattenComments(currentPost)"
      :key="item[1].id"
    >
      <div class="flex gap-2">

        <!-- comment indentation guide -->
        <template
          x-for="_ in Array(item[0])"
        >
          <span class="size-10"></span>
        </template>

        <!-- comment outer container -->
        <div class="px-6 py-4" >
          <!-- comment inner container -->
          <div class="flex flex-row gap-x-2 align-top">
            <!-- comment profile picture -->
            <div class="min-w-10">
              <template x-if="item[1].is_anonymous">
                <img class="size-10 rounded-full bg-gray-600" :src="IMG_ANON_AVATAR" draggable="false" aria-hidden="true">
              </template>
              <template x-if="!item[1].is_anonymous && getAvatar(item[1], userMap)">
                <img class="size-10 rounded-full" :src="getAvatar(item[1], userMap)" alt="user avatar">
              </template>
              <template x-if="!item[1].is_anonymous && !getAvatar(item[1], userMap)">
                <div class="relative inline-flex items-center justify-center size-10 overflow-hidden bg-gray-100 rounded-full dark:bg-gray-600">
                  <span
                    class="font-light text-gray-600 dark:text-gray-300"
                    x-text="getNameAbbrev(item[1], userMap)"
                  ></span>
                </div>
              </template>
            </div>

            <div class="space-y-1 overflow-x-auto">
              <!-- comment header -->
              <div class="flex gap-2 text-sm font-light items-baseline pb-2">
                <!-- comment username -->
                <div class="flex items-center gap-1">
                  <span
                    x-text="getAuthorName(item[1], userMap)"
                  ></span>
                  <span
                    class="text-[0.5rem] font-semibold bg-[#372dad] rounded-md px-1"
                    x-show="!item[1].is_anonymous && userMap[item[1].user_id].course_role === 'admin'"
                  >
                    STAFF
                  </span>
                </div>

                <!-- comment date -->
                <span
                  class="text-xs"
                  x-text="formatDate(item[1].created_at)"
                ></span>
              </div>

              <!-- comment content -->
              <span
                class="text-sm font-light"
                x-html="item[1].content"
              ></span>

              <!-- comment likes -->
              <div :id="item[1].id + '-comment-likes'" class="flex gap-1 items-center text-xs">
                <span
                  class="text-red-400"
                >&hearts;</span>
                <span
                  x-text="item[1].vote_count"
                ></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</div>
